<!doctype html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Socket.IO - 랜덤 Nickname</title>
        <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    </head>
    <body>
        <h1>Socket.IO 연결 테스트</h1>
        <button id="sendMessageBtn">서버에 메시지 보내기</button>
        <button id="generateNickBtn">랜덤 Nickname 생성</button>
        <p id="nickname">현재 닉네임: <span id="nickNameValue"></span></p>
        <p id="response"></p>

        <script>
            // 랜덤 Nickname 생성 함수
            function generateRandomNickName() {
                const randomNum = Math.floor(Math.random() * 10000) // 0-9999까지 랜덤 숫자
                const nickName = `Tester-${randomNum}`

                return nickName
            }

            // localStorage에서 nickName 불러오기
            function getNickName() {
                let nickName = localStorage.getItem('nickName')
                if (!nickName) {
                    // nickName이 없으면 랜덤으로 생성해서 저장
                    nickName = generateRandomNickName()
                    localStorage.setItem('nickName', nickName)
                }

                return nickName
            }

            // localStorage에서 불러온 nickName을 페이지에 표시
            function displayNickName() {
                const nickName = getNickName()
                document.getElementById('nickNameValue').textContent = nickName
            }

            // 페이지 로드 시 닉네임 표시
            displayNickName()

            // socket.io 연결
            const socket = io('http://localhost:8000', {
                reconnection: true, // 자동 재연결 활성화
                reconnectionAttempts: Infinity, // 무한 재연결 시도
                reconnectionDelay: 1000, // 재연결 시도 간 간격 (ms)
                reconnectionDelayMax: 5000, // 재연결 시도 간 최대 지연 시간 (ms)
                timeout: 5000, // 연결 시도 타임아웃 (ms)

                // localStorage에서 nickName 불러와서 auth로 전달
                auth: {
                    clientId: getNickName(),
                },
            })

            // 연결 성공 시
            socket.on('connect', () => {
                console.log('서버에 연결됨, socket id:', socket.id)
                document.getElementById('response').textContent =
                    `서버에 연결됨! (ID: ${socket.id})`
            })

            // 서버에서 메시지 받기
            socket.on('server_message', (message) => {
                console.log('서버로부터 메시지:', message)
                document.getElementById('response').textContent = message
            })

            // 서버와의 연결 끊어짐 처리
            socket.on('disconnect', () => {
                console.log('서버와의 연결이 끊어졌습니다.')
                document.getElementById('response').textContent =
                    '서버와의 연결이 끊어졌습니다.'
            })

            // 랜덤 Nickname 생성 버튼 클릭 시
            document
                .getElementById('generateNickBtn')
                .addEventListener('click', () => {
                    const newNickName = generateRandomNickName()
                    localStorage.setItem('nickName', newNickName) // 새로운 Nickname을 localStorage에 저장
                    displayNickName() // 새로운 닉네임 화면에 반영

                    console.log(`새로운 Nickname 생성: ${newNickName}`)
                    alert(`새로운 Nickname: ${newNickName}`)
                })

            // 메시지 보내기 버튼 클릭 시 서버로 메시지 전송
            document
                .getElementById('sendMessageBtn')
                .addEventListener('click', () => {
                    const message = 'Hello from client!'
                    console.log('서버로 메시지 전송:', message)
                    socket.emit('client_message', message)
                })
        </script>
    </body>
</html>
