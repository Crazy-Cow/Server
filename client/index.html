<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Socket.IO Client</title>
        <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>
    <body>
        <h1>Socket.IO Client</h1>

        <!-- Nickname Registration Section -->
        <label for="nickname">별명</label>
        <input id="nickname" />
        <button id="checkNicknameButton">별명 등록</button>
        <span id="nicknameStatus"></span>
        <br />

        <span id="accessToken">AccessToken</span>
        <br />

        <!-- Room Interaction -->
        <button id="joinRoomButton">Join Room</button>
        <button id="leaveRoomButton">Leave Room</button>
        <br />
        <div id="roomState"></div>
        <br />
        <div id="gamePlay"></div>
        <br />
        <div id="gameState"></div>

        <script>
            let accessToken = ''
            let socket

            // Register nickname
            $('#checkNicknameButton').click(function () {
                const nickname = document.getElementById('nickname').value
                if (!nickname) {
                    $('#nicknameStatus').text('[nickName] is required')
                    return
                }

                fetch('http://localhost:8000/user/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickName: nickname }),
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(
                                `HTTP error! status: ${response.status}`
                            )
                        }
                        return response.json()
                    })
                    .then((data) => {
                        accessToken = data.accessToken
                        $('#accessToken').text(`accessToken: ${accessToken}`)
                        $('#nicknameStatus').text(`등록 성공: ${nickname}`)
                    })
                    .catch((error) => {
                        $('#nicknameStatus').text('오류 발생')
                    })
            })

            // Join Room
            $('#joinRoomButton').click(function () {
                socket = io.connect('http://localhost:8000', {
                    auth: { token: accessToken },
                })

                // Room State Update
                socket.on('room.changeState', (data) => {
                    $('#roomState').text(`Room State: ${JSON.stringify(data)}`)
                })

                // Game Start
                socket.on('game.start', (data) => {
                    $('#gamePlay').text(`GAME START!: ${JSON.stringify(data)}`)
                })

                // Game Over
                socket.on('game.over', (data) => {
                    $('#gamePlay').text(`GAME END!`)
                })

                // Game State Update
                socket.on('game.state', (data) => {
                    $('#gameState').text(`Game State: ${JSON.stringify(data)}`)
                })

                socket.emit('room.enter')
                console.log('emit (room.enter)')
            })

            // Leave Room
            $('#leaveRoomButton').click(function () {
                socket.emit('room.leave')
                console.log('emit (room.leave)')
            })
        </script>
    </body>
</html>
